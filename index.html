<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Organizaci칩n de Grupos</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Tipograf칤a del sistema de Apple */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background: linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%);
            background-attachment: fixed;
            margin: 0;
            padding: 0;
            overflow: hidden; 
        }

        /* Barra de men칰 superior estilo Mac */
        .mac-menubar {
            background-color: rgba(255, 255, 255, 0.4);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 13px;
            font-weight: 500;
            color: #1d1d1f;
        }

        /* Estilo de la ventana de cristal */
        .mac-window {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), inset 0 1px 0 rgba(255, 255, 255, 0.8);
            border-radius: 12px;
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        /* 츼rea de arrastre dentro de la ventana */
        .dropzone {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            min-height: 150px;
            transition: all 0.2s ease;
            border-radius: 0 0 12px 12px;
        }

        .dropzone.drag-over {
            background: rgba(0, 122, 255, 0.1);
            box-shadow: inset 0 0 0 2px #007AFF;
        }

        /* Tarjeta del estudiante */
        .student-card {
            background: #ffffff;
            border: 1px solid rgba(0,0,0,0.05);
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            border-radius: 8px;
            padding: 10px 12px;
            margin-bottom: 8px;
            cursor: grab;
            transition: transform 0.15s ease, box-shadow 0.15s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .student-card:hover {
            box-shadow: 0 4px 10px rgba(0,0,0,0.08);
            transform: translateY(-1px);
        }

        .student-card:active {
            cursor: grabbing;
        }

        .student-card.dragging {
            opacity: 0.5;
            transform: scale(0.95);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
        }

        /* Scrollbars estilo Mac */
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: rgba(0, 0, 0, 0.2); border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: rgba(0, 0, 0, 0.3); }
        
        /* Estilos del Modal Mac */
        .mac-modal-overlay {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        .mac-modal {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(25px);
            -webkit-backdrop-filter: blur(25px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.2);
            border-radius: 12px;
        }

        /* Estilos de las pesta침as */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 8px 8px 0 0;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            border: 1px solid transparent;
            border-bottom: none;
            background: rgba(255, 255, 255, 0.3);
            color: #4b5563;
        }
        
        .tab-btn.active {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(10px);
            border-color: rgba(255, 255, 255, 0.5);
            color: #1f2937;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
            font-weight: 600;
        }

        .tab-btn:hover:not(.active) {
            background: rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="h-screen flex flex-col relative">

    <!-- Pantalla de Carga Limpia -->
    <div id="loading-overlay" class="absolute inset-0 bg-white/80 backdrop-blur-md z-[200] flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-12 h-12 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mb-4" id="loading-spinner"></div>
        <p id="loading-text" class="text-gray-800 font-medium text-lg">Sincronizando grupos...</p>
    </div>

    <!-- Men칰 Superior (Mac Menu Bar) -->
    <nav class="mac-menubar h-7 w-full flex items-center justify-between px-4 z-50 fixed top-0">
        <div class="flex items-center gap-4">
            <svg class="w-4 h-4 text-black" viewBox="0 0 384 512" fill="currentColor">
                <path d="M318.7 268.7c-.2-36.7 16.4-64.4 50-84.8-18.8-26.9-47.2-41.7-84.7-44.6-35.5-2.8-74.3 20.7-88.5 20.7-15 0-49.4-19.7-76.4-19.7C63.3 141.2 4 184.8 4 273.5q0 39.3 14.4 81.2c12.8 36.7 59 126.7 107.2 125.2 25.2-.6 43-17.9 75.8-17.9 31.8 0 48.3 17.9 76.4 17.9 48.6-.7 90.4-82.5 102.6-119.3-65.2-30.7-61.7-90-61.7-91.9zm-56.6-164.2c27.3-32.4 24.8-61.9 24-72.5-24.1 1.4-52 16.4-67.9 34.9-17.5 19.8-27.8 44.3-25.6 71.9 26.1 2 49.9-11.4 69.5-34.3z"/>
            </svg>
            <span class="font-bold cursor-default">Organizador en la Nube</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-30 px-2 rounded">Archivo</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-30 px-2 rounded">Edici칩n</span>
            <span class="cursor-pointer hover:bg-white hover:bg-opacity-30 px-2 rounded" onclick="exportData()">Exportar Configuraci칩n</span>
        </div>
        <div class="flex items-center gap-4">
            <button id="lock-btn" onclick="openLockModal()" class="flex items-center gap-1 cursor-pointer hover:bg-white hover:bg-opacity-30 px-2 rounded transition-colors" title="Bloquear/Desbloquear edici칩n">
                <svg id="lock-icon" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path></svg>
                <span id="lock-text" class="text-green-700">Desbloqueado</span>
            </button>
            <span id="clock" class="cursor-default"></span>
        </div>
    </nav>

    <!-- 츼rea Principal -->
    <main class="flex-1 mt-7 p-6 overflow-hidden flex flex-col gap-2">
        <div class="flex justify-between items-end">
            <div>
                <h1 id="main-title" class="text-3xl font-semibold text-gray-900 drop-shadow-sm tracking-tight">Grupos de Trabajo</h1>
                <p id="main-subtitle" class="text-gray-700 mt-1 font-medium">Grupo 39 de Derecho - Los cambios se guardan y reflejan para todos en tiempo real</p>
            </div>
        </div>

        <div class="flex mt-4 border-b border-white/50 relative z-10">
            <button id="tab-familia" class="tab-btn active" onclick="switchSubject('familia')">Civil Familia</button>
            <button id="tab-obligaciones" class="tab-btn ml-1" onclick="switchSubject('obligaciones')">Civil Obligaciones</button>
        </div>

        <div id="groups-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 h-full overflow-y-auto pt-4 pb-10 bg-white/10 rounded-b-xl px-2">
            <!-- Las ventanas se generar치n aqu칤 -->
        </div>
    </main>

    <!-- Modal de Contrase침a -->
    <div id="password-modal" class="hidden fixed inset-0 mac-modal-overlay z-[100] flex items-center justify-center">
        <div class="mac-modal w-80 p-5 text-center transform transition-all">
            <div class="w-12 h-12 mx-auto bg-blue-100 rounded-full flex items-center justify-center mb-3">
                <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path></svg>
            </div>
            <h3 id="modal-title" class="text-lg font-semibold text-gray-900 mb-1">Seguridad del Administrador</h3>
            <p id="modal-desc" class="text-sm text-gray-600 mb-4">Ingresa la contrase침a maestra.</p>
            <input type="password" id="password-input" class="w-full border border-gray-300 rounded-md px-3 py-2 text-sm focus:outline-none focus:border-blue-500 focus:ring-1 focus:ring-blue-500 mb-4" placeholder="Contrase침a...">
            <div class="flex gap-2">
                <button onclick="closeModal()" class="flex-1 px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 text-sm font-medium rounded-md transition-colors">Cancelar</button>
                <button onclick="submitPassword()" class="flex-1 px-4 py-2 bg-blue-500 hover:bg-blue-600 text-white text-sm font-medium rounded-md transition-colors">Aceptar</button>
            </div>
        </div>
    </div>

    <!-- Script principal Firebase y L칩gica -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // ==========================================
        // 游뚿 CONFIGURACI칍N DE FIREBASE PARA GITHUB 游뚿
        // ==========================================
        
        const firebaseConfig = {
            apiKey: "AIzaSyDCHQ-yK7UjldoqwXJ8OoBSGaFpvlI2QoQ",
            authDomain: "basesdedatos-8545b.firebaseapp.com",
            projectId: "basesdedatos-8545b",
            storageBucket: "basesdedatos-8545b.firebasestorage.app",
            messagingSenderId: "423832305020",
            appId: "1:423832305020:web:2a6d2a7599bfaa43e838f9"
        };

        // Variables Globales
        const isConfigured = firebaseConfig.apiKey !== "TU_API_KEY" && firebaseConfig.apiKey !== "";
        let isLocked = false;
        let globalPassword = "";
        let currentSubject = 'familia';
        let currentData = [];
        let draggedItem = null;
        let pendingUpdate = null;
        let db, auth;
        let unsubscribeGroups = null;
        let unsubscribeGlobal = null;
        let isSyncing = false;

        // Datos Iniciales
        const initialData = [
            { id: "group-1", title: "Grupo 1", color: "blue", topic: "", students: [
                { id: "91024", name: "William Fernando Guzman Cabrera" }, { id: "91670", name: "Aura Alejandra Rosas Arciniegas" }, { id: "91921", name: "Milciades Ducuara Rodriguez" }, { id: "92615", name: "Jose De Jesus Chavez Mendez" }, { id: "91918", name: "Wilson Steep Villarreal Cuellar" }
            ]},
            { id: "group-2", title: "Grupo 2", color: "purple", topic: "", students: [
                { id: "90621", name: "Jorge Andres Mu침oz Barrera" }, { id: "91563-1", name: "Alix Maria Gonzalez Acu침a" }, { id: "91672", name: "Jose Daniel Vega Aponte" }
            ]},
            { id: "group-3", title: "Grupo 3", color: "indigo", topic: "", students: [
                { id: "91002", name: "Jeison Fabian Trivi침o Cabiativa" }, { id: "91021", name: "Humberto Carlos Aranzalez Vanegas" }, { id: "91424", name: "Quidian Andrei Torres Medina" }, { id: "91892", name: "Carlos Andr칠s Florez Gonz치lez" }, { id: "92614", name: "William Javier Morales Vargas" }
            ]},
            { id: "group-4", title: "Grupo 4", color: "teal", topic: "", students: [
                { id: "90149", name: "Sami Estiwens Carvajal Marin" }, { id: "90690", name: "Fabian Mu침oz Villanueva" }, { id: "91563-2", name: "Diego Fernando Pe침a Cuartas" }, { id: "91668", name: "Edgar Henry Cardona Echavarria" }, { id: "92181", name: "Jairo Humberto Pinzon Herrera" }, { id: "92633", name: "Jhonny Gabriel Vallejo Barahona" }
            ]},
            { id: "group-5", title: "Grupo 5", color: "green", topic: "", students: [
                { id: "91022", name: "Jeferson David Murcia Rodriguez" }, { id: "91667", name: "Carlos Eduardo Guarin Salgado" }, { id: "91683", name: "Juan Carlos Cardona Garavito" }, { id: "92165", name: "Dairon Styven Esquivel Yepes" }, { id: "92626", name: "Humberto Jose Fernandez Paz" }
            ]},
            { id: "group-6", title: "Grupo 6", color: "orange", topic: "", students: [
                { id: "91025", name: "Elver Joaquin Fonseca Silva" }, { id: "92175", name: "Monica Andrea Diaz Herrera" }, { id: "92188", name: "Edison Enrique Moreno Mora" }
            ]},
            { id: "group-7", title: "Grupo 7", color: "red", topic: "", students: [
                { id: "91678", name: "Leidy Yurleny Palacios Loaiza" }, { id: "92127", name: "Faiver Bravo Hernandez" }, { id: "92182", name: "Natalia Espejo Pallares" }, { id: "92200", name: "Luis Fernando Olivera Arevalo" }, { id: "92368", name: "Roberto Giraldo Veloza" }
            ]},
            { id: "group-8", title: "Grupo 8", color: "pink", topic: "", students: [
                { id: "90691", name: "Crystel Yohana Moreno Perez" }, { id: "91006", name: "Carlos Mario Agamez Se침a" }, { id: "91007", name: "Magda Marleny Cardenas Suarez" }, { id: "91420", name: "Diana Catalina Mora Romero" }
            ]},
            { id: "group-9", title: "Grupo 9", color: "cyan", topic: "", students: [
                { id: "91356", name: "Hermann Buitrago Otalvaro" }, { id: "92166", name: "Eder Mauricio Suescun Alsina" }, { id: "92374", name: "Alexander Romero Ovalle" }, { id: "92644", name: "Kimberly Tatiana Martinez Retavisca" }, { id: "92645", name: "Luis Carlos Diaz Lozano" }
            ]},
            { id: "group-10", title: "Grupo 10", color: "lime", topic: "", students: [
                { id: "90595", name: "Alexander Casta침eda Rodriguez" }, { id: "91015", name: "Alexander Lopez Barona" }, { id: "91412", name: "Katherine Duran Roa" }
            ]},
            { id: "group-11", title: "Grupo 11", color: "yellow", topic: "", students: [
                { id: "91409", name: "Diana Carolina Bejarano Arias" }
            ]},
            { id: "group-12", title: "Grupo 12", color: "rose", topic: "", students: [
                { id: "91661", name: "Nelcy Aldana Carrillo" }, { id: "92178", name: "Leidy Maria Barros Lesmes" }, { id: "92193", name: "Adriana Quintero Giral" }
            ]},
            { id: "unassigned", title: "Sin Asignar (Reserva)", color: "gray", topic: "", students: [] }
        ];

        // INICIALIZACI칍N
        if (isConfigured) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            initAuth();
        } else {
            // Fallback silencioso si faltan las claves
            loadSubjectLocally(currentSubject);
        }

        async function initAuth() {
            onAuthStateChanged(auth, (user) => {
                if (user) {
                    startCloudSync();
                }
            });

            try {
                await signInAnonymously(auth);
            } catch (error) {
                console.error("Error de Autenticaci칩n:", error);
                loadSubjectLocally(currentSubject);
            }
        }

        // ==========================================
        // MODO NUBE (FIREBASE)
        // ==========================================
        function startCloudSync() {
            if (!auth.currentUser || isSyncing) return;
            isSyncing = true;

            const globalRef = doc(db, 'organizador_grupos', 'config_global');
            
            unsubscribeGlobal = onSnapshot(globalRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    isLocked = data.isLocked || false;
                    globalPassword = data.password || "";
                } else {
                    isLocked = false;
                    globalPassword = "";
                }
                applyLockState();
            }, (error) => console.error("Error global:", error));

            loadSubjectFromCloud(currentSubject);
        }

        function loadSubjectFromCloud(subject) {
            if (unsubscribeGroups) unsubscribeGroups(); 
            
            const subjectRef = doc(db, 'organizador_grupos', `estado_${subject}`);
            
            unsubscribeGroups = onSnapshot(subjectRef, (docSnap) => {
                let newData = [];
                let isFirstTime = false;

                if (docSnap.exists() && docSnap.data().groups) {
                    newData = docSnap.data().groups;
                } else {
                    newData = JSON.parse(JSON.stringify(initialData));
                    isFirstTime = true;
                }

                if (!isFirstTime) {
                    initialData.forEach(initGroup => {
                        let existingGroup = newData.find(g => g.id === initGroup.id);
                        if (!existingGroup) {
                            const unIndex = newData.findIndex(g => g.id === 'unassigned');
                            if (unIndex !== -1) newData.splice(unIndex, 0, JSON.parse(JSON.stringify(initGroup)));
                            else newData.push(JSON.parse(JSON.stringify(initGroup)));
                        } else {
                            initGroup.students.forEach(initStudent => {
                                let studentExists = false;
                                newData.forEach(g => { if (g.students.find(s => s.id === initStudent.id)) studentExists = true; });
                                if (!studentExists) existingGroup.students.push(JSON.parse(JSON.stringify(initStudent)));
                            });
                        }
                    });
                }

                if (draggedItem) {
                    pendingUpdate = newData;
                } else {
                    currentData = newData;
                    renderGroups();
                    hideLoader();
                }
                saveStateCore(newData);
            }, (error) => {
                console.error("Error base de datos:", error);
                loadSubjectLocally(currentSubject);
            });
        }

        function hideLoader() {
            const loader = document.getElementById('loading-overlay');
            if (loader && !loader.classList.contains('hidden')) {
                loader.style.opacity = '0';
                setTimeout(() => loader.classList.add('hidden'), 500);
            }
        }

        // ==========================================
        // MODO LOCAL (Fallback autom치tico)
        // ==========================================
        function loadSubjectLocally(subject) {
            hideLoader();
            const savedData = localStorage.getItem(`mac_groups_data_${subject}`);
            if (savedData) currentData = JSON.parse(savedData);
            else currentData = JSON.parse(JSON.stringify(initialData));

            isLocked = localStorage.getItem('mac_groups_locked') === 'true';
            globalPassword = localStorage.getItem('mac_groups_pwd') || "";
            renderGroups();
        }

        // ==========================================
        // GUARDADO UNIFICADO
        // ==========================================
        async function saveStateCore(stateArray = null) {
            let stateToSave = stateArray;
            if (!stateToSave) {
                stateToSave = [];
                document.querySelectorAll('.mac-window').forEach(windowEl => {
                    let dropzone = windowEl.querySelector('.dropzone');
                    if(!dropzone) return;
                    
                    let students = [];
                    dropzone.querySelectorAll('.student-card').forEach(card => {
                        students.push({ id: card.dataset.id, name: card.dataset.name });
                    });
                    
                    stateToSave.push({ 
                        id: dropzone.id, 
                        title: windowEl.querySelector('h2').textContent, 
                        topic: windowEl.querySelector('.topic-input') ? windowEl.querySelector('.topic-input').value : "", 
                        students: students 
                    });
                });
            }

            if (isConfigured && auth && auth.currentUser) {
                try {
                    await setDoc(doc(db, 'organizador_grupos', `estado_${currentSubject}`), { groups: stateToSave }, { merge: true });
                } catch (e) { console.error("Error al guardar:", e); }
            } else {
                localStorage.setItem(`mac_groups_data_${currentSubject}`, JSON.stringify(stateToSave));
            }
        }

        // ==========================================
        // FUNCIONES DE INTERFAZ
        // ==========================================
        window.switchSubject = (subject) => {
            if (draggedItem) return;
            currentSubject = subject;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.getElementById(`tab-${subject}`).classList.add('active');
            
            if (isConfigured && auth && auth.currentUser) loadSubjectFromCloud(currentSubject);
            else loadSubjectLocally(currentSubject);
        };

        window.saveState = () => saveStateCore();

        window.openLockModal = () => {
            const modalTitle = document.getElementById('modal-title');
            const modalDesc = document.getElementById('modal-desc');
            const passInput = document.getElementById('password-input');
            
            if (!globalPassword) {
                modalTitle.textContent = "Crear Contrase침a Maestra";
                modalDesc.textContent = "Crea una clave para proteger el panel para todos los usuarios.";
            } else {
                modalTitle.textContent = isLocked ? "Desbloquear Edici칩n" : "Bloquear Edici칩n";
                modalDesc.textContent = isLocked ? "Ingresa la clave para permitir cambios." : "Ingresa la clave para bloquear.";
            }
            
            passInput.value = '';
            document.getElementById('password-modal').classList.remove('hidden');
            setTimeout(() => passInput.focus(), 100);
        };

        window.closeModal = () => document.getElementById('password-modal').classList.add('hidden');

        window.submitPassword = async () => {
            const inputVal = document.getElementById('password-input').value;
            if (!inputVal) return;

            if (isConfigured && auth && auth.currentUser) {
                const globalRef = doc(db, 'organizador_grupos', 'config_global');
                if (!globalPassword) {
                    await setDoc(globalRef, { password: inputVal, isLocked: true }, { merge: true });
                    window.closeModal();
                } else if (inputVal === globalPassword) {
                    await setDoc(globalRef, { isLocked: !isLocked }, { merge: true });
                    window.closeModal();
                } else {
                    alert("Contrase침a incorrecta.");
                }
            } else {
                if (!globalPassword) {
                    localStorage.setItem('mac_groups_pwd', inputVal);
                    localStorage.setItem('mac_groups_locked', 'true');
                    globalPassword = inputVal;
                    isLocked = true;
                    applyLockState();
                    window.closeModal();
                } else if (inputVal === globalPassword) {
                    isLocked = !isLocked;
                    localStorage.setItem('mac_groups_locked', isLocked.toString());
                    applyLockState();
                    window.closeModal();
                } else {
                    alert("Contrase침a incorrecta.");
                }
            }
        };

        window.exportData = () => {
            let exportObj = { asignatura: currentSubject, grupos: {} };
            document.querySelectorAll('.mac-window').forEach(windowEl => {
                let dropzone = windowEl.querySelector('.dropzone');
                if(!dropzone) return;
                exportObj.grupos[dropzone.id] = {
                    tema: windowEl.querySelector('.topic-input') ? windowEl.querySelector('.topic-input').value : "",
                    integrantes: Array.from(dropzone.querySelectorAll('.student-card')).map(card => ({ id: card.dataset.id, name: card.dataset.name }))
                };
            });
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(exportObj, null, 2));
            const dlAnchorElem = document.createElement('a');
            dlAnchorElem.setAttribute("href", dataStr);
            dlAnchorElem.setAttribute("download", `organizacion_grupos_${currentSubject}.json`);
            dlAnchorElem.click();
        };

        document.getElementById('password-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') window.submitPassword();
        });

        function renderGroups() {
            const container = document.getElementById('groups-container');
            container.innerHTML = '';

            currentData.forEach(group => {
                const windowEl = document.createElement('div');
                windowEl.className = 'mac-window h-full flex flex-col';

                // 1. CABECERA
                const header = document.createElement('div');
                header.className = 'px-4 py-3 border-b border-white/40 flex items-center bg-white/30 rounded-t-xl';
                header.innerHTML = `
                    <div class="flex gap-2 mr-4">
                        <div class="w-3 h-3 rounded-full bg-[#FF5F56] border border-[#E0443E] shadow-sm"></div>
                        <div class="w-3 h-3 rounded-full bg-[#FFBD2E] border border-[#DEA123] shadow-sm"></div>
                        <div class="w-3 h-3 rounded-full bg-[#27C93F] border border-[#1AAB29] shadow-sm"></div>
                    </div>
                    <div class="flex-1 text-center pr-10">
                        <h2 class="text-[14px] font-semibold text-gray-800">${group.title}</h2>
                        <p class="text-[11px] text-gray-600 count-badge" id="count-${group.id}">${group.students.length} integrantes</p>
                    </div>
                `;

                // 2. ZONA DE ESTUDIANTES (Ahora va en el medio)
                const dropzone = document.createElement('div');
                dropzone.className = 'dropzone';
                dropzone.style.borderRadius = '0'; // Se le quita la curva abajo para d치rsela al recuadro del tema
                dropzone.id = group.id;

                dropzone.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
                dropzone.addEventListener('dragenter', (e) => { e.preventDefault(); let t = e.target.closest('.dropzone'); if (t) t.classList.add('drag-over'); });
                dropzone.addEventListener('dragleave', (e) => { let t = e.target.closest('.dropzone'); if (t && !t.contains(e.relatedTarget)) t.classList.remove('drag-over'); });
                dropzone.addEventListener('drop', handleDrop);

                group.students.forEach(student => { dropzone.appendChild(createStudentCard(student)); });

                // 3. ZONA DEL TEMA (Ahora va abajo y es un Textarea ajustable)
                const topicContainer = document.createElement('div');
                topicContainer.className = 'px-3 py-3 bg-white/40 border-t border-white/50 mt-auto rounded-b-xl';
                
                if(group.id !== 'unassigned') {
                    topicContainer.innerHTML = `<textarea class="topic-input w-full bg-white/60 border border-gray-200/60 rounded px-3 py-2 text-sm text-gray-700 focus:outline-none focus:bg-white focus:ring-2 focus:ring-blue-400 transition-all font-medium resize-y min-h-[65px]" placeholder="Asignar tema de exposici칩n... (Arrastra la esquina para agrandar)" onchange="saveState()">${group.topic || ''}</textarea>`;
                } else {
                    topicContainer.innerHTML = `<div class="text-xs text-gray-500 py-2 text-center italic">Zona de reasignaci칩n (Sin tema)</div>`;
                }

                // ARMADO DE LA VENTANA (Orden cambiado)
                windowEl.appendChild(header);
                windowEl.appendChild(dropzone);
                windowEl.appendChild(topicContainer);
                
                container.appendChild(windowEl);
            });
            applyLockState();
        }

                const dropzone = document.createElement('div');
                dropzone.className = 'dropzone';
                dropzone.id = group.id;

                dropzone.addEventListener('dragover', (e) => { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; return false; });
                dropzone.addEventListener('dragenter', (e) => { e.preventDefault(); let t = e.target.closest('.dropzone'); if (t) t.classList.add('drag-over'); });
                dropzone.addEventListener('dragleave', (e) => { let t = e.target.closest('.dropzone'); if (t && !t.contains(e.relatedTarget)) t.classList.remove('drag-over'); });
                dropzone.addEventListener('drop', handleDrop);

                group.students.forEach(student => { dropzone.appendChild(createStudentCard(student)); });

                windowEl.appendChild(header);
                windowEl.appendChild(topicContainer);
                windowEl.appendChild(dropzone);
                container.appendChild(windowEl);
            });
            applyLockState();
        }

        function createStudentCard(student) {
            const card = document.createElement('div');
            card.className = 'student-card';
            card.draggable = true;
            card.dataset.id = student.id;
            card.dataset.name = student.name;
            card.innerHTML = `
                <svg class="w-8 h-8 text-gray-400 bg-gray-50 rounded-full p-1 border border-gray-100" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd"></path></svg>
                <div class="flex-1 overflow-hidden">
                    <p class="text-sm font-medium text-gray-800 truncate" title="${student.name}">${student.name}</p>
                    <p class="text-xs text-gray-400 font-mono">ID: ${student.id.split('-')[0]}</p>
                </div>
                <svg class="w-4 h-4 text-gray-300 cursor-grab" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path></svg>
            `;
            card.addEventListener('dragstart', function(e) {
                if(isLocked) { e.preventDefault(); return; }
                draggedItem = this;
                setTimeout(() => this.classList.add('dragging'), 0);
            });
            card.addEventListener('dragend', function() {
                this.classList.remove('dragging');
                this.style.opacity = '1';
                draggedItem = null;
                document.querySelectorAll('.dropzone').forEach(zone => zone.classList.remove('drag-over'));
                if (pendingUpdate) { currentData = pendingUpdate; renderGroups(); pendingUpdate = null; }
            });
            return card;
        }

        function handleDrop(e) {
            e.preventDefault(); e.stopPropagation();
            let dropzone = e.target.closest('.dropzone');
            
            if (dropzone && draggedItem) {
                dropzone.classList.remove('drag-over');
                let item = draggedItem; 
                item.style.opacity = '0';
                dropzone.appendChild(item);
                setTimeout(() => { if (item) item.style.opacity = '1'; }, 50);

                document.querySelectorAll('.dropzone').forEach(zone => {
                    const cnt = zone.querySelectorAll('.student-card').length;
                    const badge = document.getElementById(`count-${zone.id}`);
                    if (badge) badge.textContent = `${cnt} ${cnt === 1 ? 'integrante' : 'integrantes'}`;
                });
                window.saveState();
            }
            return false;
        }

        function applyLockState() {
            const cards = document.querySelectorAll('.student-card');
            const inputs = document.querySelectorAll('.topic-input');
            const lockIcon = document.getElementById('lock-icon');
            const lockText = document.getElementById('lock-text');

            if (isLocked) {
                cards.forEach(card => card.setAttribute('draggable', 'false'));
                inputs.forEach(input => {
                    input.setAttribute('readonly', 'true');
                    input.classList.add('opacity-70', 'cursor-not-allowed');
                });
                lockIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z"></path>`;
                lockText.textContent = "Bloqueado para todos";
                lockText.classList.add('text-red-500'); lockText.classList.remove('text-green-700');
            } else {
                cards.forEach(card => card.setAttribute('draggable', 'true'));
                inputs.forEach(input => {
                    input.removeAttribute('readonly');
                    input.classList.remove('opacity-70', 'cursor-not-allowed');
                });
                lockIcon.innerHTML = `<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 11V7a4 4 0 118 0m-4 8v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2z"></path>`;
                lockText.textContent = "Desbloqueado";
                lockText.classList.remove('text-red-500'); lockText.classList.add('text-green-700');
            }
        }

        function updateClock() {
            const now = new Date();
            const timeString = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const dateString = now.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short' });
            document.getElementById('clock').textContent = `${dateString.replace('.', '')} ${timeString}`;
        }
        setInterval(updateClock, 1000); updateClock();

    </script>
</body>
</html>
